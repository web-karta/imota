<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
        <link rel="stylesheet" href="css/L.Control.Locate.min.css">
        <link rel="stylesheet" href="css/qgis2web.css">
<link rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=PT+Sans:wght@400;700&display=swap">

<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
        <link rel="stylesheet" href="css/leaflet-search.css">
        <link rel="stylesheet" href="css/leaflet.photon.css">
        <link rel="stylesheet" href="css/leaflet-measure.css">
        <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">

        <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }

        @media (max-width: 768px) {
  #betaFilter {
    position: fixed;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    width: 92%;
    max-height: 70vh;
    overflow-y: auto;
    z-index: 1001;
  }
}



        /* ‚¨áÔ∏è STATION LABELS ISPOD VOZILA */
.leaflet-tooltip-pane {
  z-index: 500 !important;
}

/* popup ostaje iznad svega */
.leaflet-popup-pane {
  z-index: 700 !important;
}
/* ===== INFO OKVIR ‚Äì DESNO (SVI UREƒêAJI) ===== */
#betaInfoPanel {
  position: fixed;
  top: 110px;
  right: 10px;                 /* ‚¨ÖÔ∏è 20 px od ruba */
  width: 360px;
  max-width: calc(100% - 40px);
  max-height: calc(100% - 120px);
  background: white;
  border-radius: 14px;         /* ‚¨ÖÔ∏è zaobljeno */
  box-shadow: 0 8px 24px rgba(0,0,0,0.25);
  padding: 16px 18px;
  overflow-y: auto;
  z-index: 9999;
  font-family: "PT Sans", sans-serif;
    font-size: 12px;
  opacity: 0;
  pointer-events: none;
  transform: translateX(20px);
  transition: opacity 0.25s ease, transform 0.25s ease;
  -webkit-overflow-scrolling: touch; /* iOS momentum scroll */
  overscroll-behavior: contain;
}
/* eksplicitno za touch ureƒëaje */
@media (pointer: coarse) {
  #betaInfoPanel {
    overflow-y: auto !important;
    touch-action: pan-y;
  }
}
#betaInfoPanel.open {
  opacity: 1;
  pointer-events: auto;
  transform: translateX(0);
}

#betaInfoPanel h2 {
  margin-top: 0;
  font-size: 13px;
}

#betaInfoClose {
  position: absolute;
  top: 10px;
  right: 14px;
  font-size: 24px;
  cursor: pointer;
}

/* üî§ SVI LEAFLET POPUPOVI ‚Äì PT Sans */
.leaflet-popup-content,
.leaflet-popup-content * {
  font-family: "PT Sans", Arial, sans-serif !important;
}



        </style>
        <title>IMOTA | Elektriƒçni tramvaj Imote</title>
<link rel="icon" type="image/png" href="images/BETA.png">

    </head>
    <body>
        <div id="map">
        </div>
        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/leaflet.js"></script>
        <script src="js/L.Control.Layers.Tree.min.js"></script>
        <script src="js/L.Control.Locate.min.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet.photon.js"></script>
        <script src="js/leaflet-measure.js"></script>
        <script src="js/leaflet-search.js"></script>
        <script src="data/TramvajskamreaopineGrude_1.js"></script>
        <script src="data/Tramvajskestanice_2.js"></script>
        <script>
            const IS_MOBILE = window.matchMedia('(max-width: 768px)').matches;
const INITIAL_ZOOM = IS_MOBILE ? 13 : 14;

 var map = L.map('map', {
    zoomControl: false,
    maxZoom: 28,
    minZoom: 12,
      attributionControl: false   // ‚¨ÖÔ∏è ovo

});

// ===== PANE ZA VOZILA (UVIJEK IZNAD LABELA) =====
map.createPane('vehiclePane');
map.getPane('vehiclePane').style.zIndex = 600;


map.fitBounds(
  [[43.326887864413045,17.37499470989582],
   [43.38253614046646,17.471967844816543]]
);

// üîë forsiraj poƒçetni zoom po ureƒëaju
map.setZoom(INITIAL_ZOOM);
function findNearestStation(latlng) {
  let best = null;
  let bestDist = Infinity;

  stationById.forEach((st, id) => {
    const d = map.distance(latlng, L.latLng(st.latlng));
    if (d < bestDist) {
      bestDist = d;
      best = { id, name: st.name, dist: d };
    }
  });

  return best;
}


        var hash = new L.Hash(map);
        var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});
        // remove popup's row if "visible-with-data"
        function removeEmptyRowsFromPopupContent(content, feature) {
         var tempDiv = document.createElement('div');
         tempDiv.innerHTML = content;
         var rows = tempDiv.querySelectorAll('tr');
         for (var i = 0; i < rows.length; i++) {
             var td = rows[i].querySelector('td.visible-with-data');
             var key = td ? td.id : '';
             if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
                 rows[i].parentNode.removeChild(rows[i]);
             }
         }
         return tempDiv.innerHTML;
        }
        // modify popup if contains media
        function addClassToPopupIfMedia(content, popup) {
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            var imgTd = tempDiv.querySelector('td img');
            if (imgTd) {
                var src = imgTd.getAttribute('src');
                if (/\.(jpg|jpeg|png|gif|bmp|webp|avif)$/i.test(src)) {
                    popup._contentNode.classList.add('media');
                    setTimeout(function() {
                        popup.update();
                    }, 10);
                } else if (/\.(mp3|wav|ogg|aac)$/i.test(src)) {
                    var audio = document.createElement('audio');
                    audio.controls = true;
                    audio.src = src;
                    imgTd.parentNode.replaceChild(audio, imgTd);
                    popup._contentNode.classList.add('media');
                    setTimeout(function() {
                        popup.setContent(tempDiv.innerHTML);
                        popup.update();
                    }, 10);
                } else if (/\.(mp4|webm|ogg|mov)$/i.test(src)) {
                    var video = document.createElement('video');
                    video.controls = true;
                    video.src = src;
                    video.style.width = "400px";
                    video.style.height = "300px";
                    video.style.maxHeight = "60vh";
                    video.style.maxWidth = "60vw";
                    imgTd.parentNode.replaceChild(video, imgTd);
                    popup._contentNode.classList.add('media');
                    // Aggiorna il popup quando il video carica i metadati
                    video.addEventListener('loadedmetadata', function() {
                        popup.update();
                    });
                    setTimeout(function() {
                        popup.setContent(tempDiv.innerHTML);
                        popup.update();
                    }, 10);
                } else {
                    popup._contentNode.classList.remove('media');
                }
            } else {
                popup._contentNode.classList.remove('media');
            }
        }
const locateControl = L.control.locate({
  position: 'topright',   // ‚¨ÖÔ∏è DESNO
  strings: {
    title: "Pronaƒëi moju lokaciju",
    metersUnit: "metara",
    popup: "Nalazite se unutar {distance} {unit} od ove toƒçke",
    outsideMapBoundsMsg: "Nalazite se izvan granica karte."
  },
  locateOptions: {
    maxZoom: 19,
    enableHighAccuracy: true
  },
  flyTo: true,
  showPopup: false,   // ‚¨ÖÔ∏è MI ƒÜEMO SVOJ POPUP
  drawCircle: true,
  drawMarker: false
}).addTo(map);
map.on('locationfound', function (e) {

  // ‚ùó ako je korisnik previ≈°e udaljen (karte nema smisla)
  if (map.getZoom() < 12) {
    L.popup()
      .setLatLng(e.latlng)
      .setContent("Nalazite se izvan granica karte.")
      .openOn(map);
    return;
  }

  const nearest = findNearestStation(e.latlng);

  if (!nearest) {
    L.popup()
      .setLatLng(e.latlng)
      .setContent("Nije pronaƒëena nijedna stanica.")
      .openOn(map);
    return;
  }

  const dist =
    nearest.dist < 1000
      ? `${Math.round(nearest.dist)} m`
      : `${(nearest.dist / 1000).toFixed(2)} km`;

  const html = `
    <b>Va≈°a lokacija</b><hr style="margin:4px 0">
    Najbli≈æa stanica:<br>
    <b>${nearest.name}</b><br>
    Udaljenost: ${dist}
  `;

  L.popup({ autoClose: true })
    .setLatLng(e.latlng)
    .setContent(html)
    .openOn(map);
});

map.whenReady(() => {

  const topRight = document.querySelector('.leaflet-top.leaflet-right');
  if (!topRight) return;

  const infoBtn = document.createElement('div');
  infoBtn.classList.add('beta-info-control');

  infoBtn.className = 'leaflet-control leaflet-bar';
  infoBtn.style.background = 'white';
  infoBtn.style.width = '30px';
  infoBtn.style.height = '30px';
  infoBtn.style.display = 'flex';
  infoBtn.style.alignItems = 'center';
  infoBtn.style.justifyContent = 'center';
  infoBtn.style.cursor = 'pointer';
  infoBtn.title = 'Napomena';

infoBtn.innerHTML =
  '<i class="fas fa-tram" style="font-size:18px;"></i>';


  L.DomEvent.disableClickPropagation(infoBtn);
  L.DomEvent.disableScrollPropagation(infoBtn);

L.DomEvent.on(infoBtn, 'click', function (e) {
  L.DomEvent.stop(e);
  const panel = document.getElementById('betaInfoPanel');
  panel.classList.toggle('open');
});



  topRight.appendChild(infoBtn);
});


        var bounds_group = new L.featureGroup([]);
        function setBounds() {
        }
        map.createPane('pane_OpenStreetMap_0');
        map.getPane('pane_OpenStreetMap_0').style.zIndex = 400;
        var layer_OpenStreetMap_0 = 
L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            pane: 'pane_OpenStreetMap_0',
            opacity: 1.0,
            attribution: '',
            minZoom: 1,
            maxZoom: 28,
            minNativeZoom: 0,
            maxNativeZoom: 19
        });
        layer_OpenStreetMap_0;
        map.addLayer(layer_OpenStreetMap_0);
        function pop_TramvajskamreaopineGrude_1(feature, layer) {
            var popupContent = '<table>\
                    <tr>\
                        <td class="visible-with-data" id="Linije" colspan="2"><strong>Linije</strong><br />' + (feature.properties['Linije'] !== null ? autolinker.link(String(feature.properties['Linije']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_TramvajskamreaopineGrude_1_0() {
            return {
                pane: 'pane_TramvajskamreaopineGrude_1',
                opacity: 1,
                color: 'rgba(0,0,0,1.0)',
                dashArray: '',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 2.0,
                fillOpacity: 0,
                interactive: true,
            }
        }
        map.createPane('pane_TramvajskamreaopineGrude_1');
        map.getPane('pane_TramvajskamreaopineGrude_1').style.zIndex = 401;
        map.getPane('pane_TramvajskamreaopineGrude_1').style['mix-blend-mode'] = 'normal';
        var layer_TramvajskamreaopineGrude_1 = new L.geoJson(json_TramvajskamreaopineGrude_1, {
            attribution: '',
            interactive: true,
            dataVar: 'json_TramvajskamreaopineGrude_1',
            layerName: 'layer_TramvajskamreaopineGrude_1',
            pane: 'pane_TramvajskamreaopineGrude_1',
            onEachFeature: pop_TramvajskamreaopineGrude_1,
            style: style_TramvajskamreaopineGrude_1_0,
        });
        bounds_group.addLayer(layer_TramvajskamreaopineGrude_1);
        map.addLayer(layer_TramvajskamreaopineGrude_1);
 function pop_Tramvajskestanice_2(feature, layer) {

  // nemoj bindati stari qgis popup
  // layer.bindPopup(content, { maxHeight: 400 });

  layer.on('click', function (e) {

    // ‚≠ê BITNO: sprijeƒçi da klik ode na mapu (jer map.on('click') bri≈°e popup!)
    L.DomEvent.stopPropagation(e);

    const API = window.BETA_API;
    if (!API) return;

    const id = String(feature.properties.ID || '').trim();
    if (!id) return;

    const st = API.stationById.get(id);
    if (!st) return;

    // ukloni prethodnu selekciju (marker + timer iz beta_live)
    API.clearStationSelection();

    // sinkroniziraj dropdown (da poka≈æe odabranu)
    const stationSel = document.getElementById('betaStationSel');
    if (stationSel) stationSel.value = id;

    // marker za popup (isti kao dropdown)
    const m = L.marker(st.latlng).addTo(API.stationLayer);

    let popupTimer = null;

    function updatePopup() {
      const arr = API.arrivalsForStation(id, API.nowSec());

      const html =
        `<b>${st.name}</b><hr style="margin:4px 0">` +
        (arr.length
          ? arr.map(a => `${a.linija} ${a.smjer} (${a.label})`).join('<br>')
          : 'Nema skorih dolazaka');

      // ‚≠ê BITNO: prvo bindPopup (da popup uopƒáe postoji), onda update
      if (!m.getPopup()) {
        m.bindPopup(html, { autoClose: true, closeOnClick: false }).openPopup();
      } else {
        m.setPopupContent(html).openPopup();
      }
    }

    updatePopup();
    popupTimer = setInterval(updatePopup, 2000);

    // cleanup kad se zatvori popup
    m.on('popupclose', () => {
      if (popupTimer) clearInterval(popupTimer);
    });

    API.map.setView(st.latlng, Math.max(API.map.getZoom(), 17));
  });
}


        function style_Tramvajskestanice_2_0() {
            return {
                pane: 'pane_Tramvajskestanice_2',
        rotationAngle: 0.0,
        rotationOrigin: 'center center',
        icon: L.icon({
            iconUrl: 'markers/Tramvajskestanice_2.svg',
            iconSize: [19.0, 19.0]
        }),
                interactive: true,
            }
        }

        const STATION_ICON_NORMAL = L.icon({
  iconUrl: 'markers/Tramvajskestanice_2.svg',
  iconSize: [18, 18],
  iconAnchor: [9.5, 9.5]
});

const STATION_ICON_SMALL = L.icon({
  iconUrl: 'markers/Tramvajskestanice_2.svg',
  iconSize: [12, 12],
  iconAnchor: [6, 6]
});

        map.createPane('pane_Tramvajskestanice_2');
        map.getPane('pane_Tramvajskestanice_2').style.zIndex = 550;
        map.getPane('pane_Tramvajskestanice_2').style['mix-blend-mode'] = 'normal';
        var layer_Tramvajskestanice_2 = new L.geoJson(json_Tramvajskestanice_2, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Tramvajskestanice_2',
            layerName: 'layer_Tramvajskestanice_2',
            pane: 'pane_Tramvajskestanice_2',
            onEachFeature: pop_Tramvajskestanice_2,
 pointToLayer: function (feature, latlng) {
  return L.marker(latlng, {
    icon: STATION_ICON_NORMAL,
    interactive: true,
    pane: 'pane_Tramvajskestanice_2'
  });
},

        });
        bounds_group.addLayer(layer_Tramvajskestanice_2);
        map.addLayer(layer_Tramvajskestanice_2);

        function updateStationIconsByZoom() {
  const isMobile = window.matchMedia('(max-width: 768px)').matches;
  if (!isMobile) return;

  const z = map.getZoom();
  const useSmall = z < 16;

  layer_Tramvajskestanice_2.eachLayer(m => {
    if (!m.setIcon) return;
    m.setIcon(useSmall ? STATION_ICON_SMALL : STATION_ICON_NORMAL);
  });
}

// inicijalno + na zoom
updateStationIconsByZoom();
map.on('zoomend', updateStationIconsByZoom);

        setBounds();
        var i = 0;
        layer_Tramvajskestanice_2.eachLayer(function(layer) {
            var context = {
                feature: layer.feature,
                variables: {}
            };
            layer.bindTooltip((layer.feature.properties['Stanica'] !== null?String('<div style="color: #323232; font-size: 10pt; font-family: \'PT Sans Narrow\', sans-serif;">' + layer.feature.properties['Stanica']) + '</div>':''), {permanent: true, offset: [-0, -16], className: 'css_Tramvajskestanice_2'});
            labels.push(layer);
            totalMarkers += 1;
              layer.added = true;
              addLabel(layer, i);
              i++;
        });
        const STATION_LABEL_MIN_ZOOM = 17;

function updateStationLabelVisibility() {
  const show = map.getZoom() >= STATION_LABEL_MIN_ZOOM;

  document.querySelectorAll('.css_Tramvajskestanice_2').forEach(el => {
    el.style.opacity = show ? '1' : '0';
    el.style.pointerEvents = show ? 'auto' : 'none';
  });
}

// inicijalno
updateStationLabelVisibility();

// na zoom
map.on('zoomend', updateStationLabelVisibility);
document.addEventListener('DOMContentLoaded', () => {
  const closeBtn = document.getElementById('betaInfoClose');
  const panel = document.getElementById('betaInfoPanel');

  if (closeBtn && panel) {
    closeBtn.addEventListener('click', () => {
      panel.classList.remove('open');
    });
  }
});

document.addEventListener('DOMContentLoaded', () => {
  const panel = document.getElementById('betaInfoPanel');

  if (!panel) return;

  // üö´ sprijeƒçi Leaflet da presretne touch
  L.DomEvent.disableClickPropagation(panel);
  L.DomEvent.disableScrollPropagation(panel);

  panel.addEventListener('touchmove', (e) => {
    e.stopPropagation();
  }, { passive: true });
});



        </script>        
    
        <script src="js/beta_data.js"></script>
        <script src="js/beta_live.js"></script>
<div id="betaInfoPanel">
  <div id="betaInfoClose">&times;</div>

  <h2>Napomena:</h2>

  <p>
    <b>DNEVNE LINIJE</b> Bekijskog elektriƒçnog tramvaja (BETA) jesu
    <b>1, 2, 3, 4 i 5</b>.
    Prometuju od ponedjeljka do subote od oko 5 do 23 sata. Svaka linija ima jedno vozilo, dok se u razdoblju od 7 do 18 sati dodaje jo≈° jedno dodatno vozilo (osim subotom).</p>
<b>Popis dnevnih tramvajskih linija:</b></p>

<b>1 DUBRAVA ‚Äî PE≈†IJA</b></br>
(Dubrava ‚Äî Prispa ‚Äî Bili Brig ‚Äî Bobo≈°ka ‚Äî Centar ‚Äî Pe≈°ija)</p>

<b>2 PE≈†IJA ‚Äî KR≈†TELICA</b></br>
(Pe≈°ija ‚Äî Centar ‚Äî Gomilice ‚Äî Kri≈°telica ‚Äî Kr≈°telica)</p>

<b>3 KR≈†TELICA ‚Äî PRISPA</b></br>
(Kr≈°telica ‚Äî Zagomila ‚Äî Bobo≈°ka ‚Äî Centar ‚Äî Otok ‚Äî Prispa)</p>

<b>4 GOMILICE ‚Äî PRISPA</b></br>
(Gomilice ‚Äî Kri≈°telica ‚Äî Zagomila ‚Äî Bili Brig ‚Äî Prispa)</p>

<b>5 POLJANICE ‚Äî GOMILICE</b></br>
(Poljanice ‚Äî Dubrava ‚Äî Prispa ‚Äî Otok ‚Äî Centar ‚Äî Gomilice)</p>
  <p>
    --------------------------------------------------------------------------</p>
    <b>POSEBNE LINIJE</b> su <b>P1 i P2</b>. Prometuju noƒáu (od 23 sata do 5 sati) te tijekom cijele nedjelje.
  </br>
    Poseban promet odvija se jo≈° i:
    01.01.‚Äì06.01., 01.03., 01.‚Äì02.05., 30.05., 22.06., 05.08., 15.08.,
    01.‚Äì02.11., 18.11., 25.11., 24.12.‚Äì31.12.,
    od Velikog ƒçetvrtka do Uskrsnog ponedjeljka te na Tijelovo.</p>
    <b>Popis posebnih tramvajskih linija:</b></p>

<b>P1 KR≈†TELICA ‚Äî POLJANICE</b></br>
(Kr≈°telica ‚Äî Zagomila ‚Äî Bobo≈°ka ‚Äî Centar ‚Äî Otok ‚Äî Prispa ‚Äî Dubrava ‚Äî Poljanice)</p>

<b>P2 PE≈†IJA ‚Äî DUBRAVA</b></br>
(Pe≈°ija ‚Äî Centar ‚Äî Gomilice ‚Äî Kri≈°telica ‚Äî Zagomila ‚Äî Bili Brig ‚Äî Prispa ‚Äî Dubrava)</p>
  </p>
  
</div>

    </body>
</html>
